name: Build TeX and Create Release

on:
  push:
    branches: [ main ]
    # push„Ç§„Éô„É≥„ÉàÂÖ®‰Ωì„ÅßËµ∑Âãï„Åï„Åõ„Åæ„Åô„Åå„ÄÅdorny/paths-filter„Åß.tex„Éï„Ç°„Ç§„É´„ÅÆ„Åø„ÇíÂØæË±°„Å´„Åó„Åæ„Åô

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # „É™„Éù„Ç∏„Éà„É™„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
      - name: Checkout repository
        uses: actions/checkout@v4

      # Â§âÊõ¥„Åï„Çå„Åü.tex„Éï„Ç°„Ç§„É´„ÅÆÊ§úÂá∫Ôºà‰ªªÊÑè„ÅÆ„Éá„Ç£„É¨„ÇØ„Éà„É™ÂÜÖ„ÅÆ„ÇÇ„ÅÆ„ÇÇÂØæË±°Ôºâ
      - name: Filter changed TeX files
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            tex:
              - '**/*.tex'
          list-files: shell



      # TeX LiveÁí∞Â¢É„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„Å®„Ç≥„É≥„Éë„Ç§„É´(xu-cheng/texlive-action„ÇíÂà©Áî®)
      - name: Setup TeX Live and Compile TeX files (lualatex)
        if: steps.filter.outputs.tex == 'true'
        uses: xu-cheng/texlive-action@v3
        with:
          run: |
            for file in ${{ steps.filter.outputs.tex_files }}; do
              echo "Compiling $file with lualatex..."
              # „Éï„Ç°„Ç§„É´„ÅÆ„Éá„Ç£„É¨„ÇØ„Éà„É™„Å´ÁßªÂãï„Åó„Å¶„Ç≥„É≥„Éë„Ç§„É´
              file_dir=$(dirname "$file")
              file_name=$(basename "$file")
              cd "$file_dir"
              # ÂèÇÁÖß„ÇíËß£Ê±∫„Åô„Çã„Åü„ÇÅ2ÂõûÂÆüË°å
              lualatex -interaction=nonstopmode "$file_name" || true
              lualatex -interaction=nonstopmode "$file_name" || true
              cd -
              echo "Compilation completed for $file"
            done

      # „Ç≥„É≥„Éë„Ç§„É´Âæå„ÄÅÂØæÂøú„Åô„ÇãPDF„Éï„Ç°„Ç§„É´„ÇíÂèéÈõÜ
      - name: Gather PDF files
        id: gather_pdfs
        run: |
          # „É¶„Éã„Éº„ÇØ„Å™„Éï„Ç°„Ç§„É´Âêç„ÅßPDF„Çí‰øùÂ≠ò„Åô„Çã„Éá„Ç£„É¨„ÇØ„Éà„É™„Çí‰ΩúÊàê
          mkdir -p release_pdfs
          FILE_LIST=""
          PDF_COUNT=0
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          
          for file in ${{ steps.filter.outputs.tex_files }}; do
            if [ -z "$file" ]; then
              continue
            fi
            # ÈÄöÂ∏∏„ÅØ.tex„Å®Âêå„Åò„Éá„Ç£„É¨„ÇØ„Éà„É™„Å´ÂêåÂêç„ÅÆ.pdf„ÅåÁîüÊàê„Åï„Çå„ÇãÂâçÊèê
            pdf_file="${file%.tex}.pdf"
            if [ -f "$pdf_file" ]; then
              base_name=$(basename "$file" .tex)
              PDF_COUNT=$((PDF_COUNT + 1))
              
              # „É¶„Éã„Éº„ÇØ„Å™„Éï„Ç°„Ç§„É´Âêç„ÇíÁîüÊàêÔºà„Çø„Ç§„É†„Çπ„Çø„É≥„Éó + ÈÄ£Áï™Ôºâ
              unique_name="latex_build_${TIMESTAMP}_${PDF_COUNT}.pdf"
              
              # PDF„Çí„É¶„Éã„Éº„ÇØ„Å™„Éï„Ç°„Ç§„É´Âêç„Åß„Ç≥„Éî„Éº
              cp "$pdf_file" "release_pdfs/${unique_name}"
              
              # SHA256„Éè„ÉÉ„Ç∑„É•„ÇíË®àÁÆóÔºàÊ§úË®ºÁî®Ôºâ
              pdf_hash=$(sha256sum "$pdf_file" | awk '{print $1}')
              pdf_size=$(stat -f%z "$pdf_file" 2>/dev/null || stat -c%s "$pdf_file")
              
              # „Éï„Ç°„Ç§„É´ÊÉÖÂ†±„Çí„É™„Çπ„Éà„Å´ËøΩÂä†
              FILE_LIST="$FILE_LIST### üìÑ \`${unique_name}\`"$'\n'
              FILE_LIST="$FILE_LIST- **ÂÖÉ„ÅÆTeX„Éï„Ç°„Ç§„É´:** \`$file\`"$'\n'
              FILE_LIST="$FILE_LIST- **ÂÖÉ„ÅÆ„Éï„Ç°„Ç§„É´Âêç:** \`${base_name}.pdf\`"$'\n'
              FILE_LIST="$FILE_LIST- **„Çµ„Ç§„Ç∫:** $(numfmt --to=iec-i --suffix=B $pdf_size 2>/dev/null || echo \"${pdf_size} bytes\")"$'\n'
              FILE_LIST="$FILE_LIST- **SHA256:** \`${pdf_hash:0:16}...\`"$'\n'
              FILE_LIST="$FILE_LIST"$'\n'
              
              echo "‚úì Generated: ${unique_name} <- ${base_name}.pdf"
            else
              echo "Warning: PDF not found for $file"
            fi
          done
          echo "pdf_count=$PDF_COUNT" >> $GITHUB_OUTPUT
          echo "file_list<<EOF" >> $GITHUB_OUTPUT
          echo "$FILE_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          # „Éá„Éê„ÉÉ„Ç∞: release_pdfs„Éá„Ç£„É¨„ÇØ„Éà„É™„ÅÆÂÜÖÂÆπ„ÇíË°®Á§∫
          echo "=== Files in release_pdfs directory ==="
          ls -la release_pdfs/
          echo "========================================"
      
      # „É™„É™„Éº„ÇπÊÉÖÂ†±„ÅÆÊ∫ñÂÇô
      - name: Prepare release info
        id: release_info
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
          SHORT_DATE=$(date +"%Y-%m-%d")
          # PDF„Éï„Ç°„Ç§„É´Âêç„ÅÆ„É™„Çπ„Éà„ÇíÂèñÂæóÔºà„Çø„Ç§„Éà„É´Áî®Ôºâ
          TITLE_NAMES=""
          for file in ${{ steps.filter.outputs.tex_files }}; do
            base_name=$(basename "$file" .tex)
            if [ -z "$TITLE_NAMES" ]; then
              TITLE_NAMES="$base_name"
            else
              TITLE_NAMES="$TITLE_NAMES, $base_name"
            fi
          done
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "short_date=$SHORT_DATE" >> $GITHUB_OUTPUT
          echo "title_names=$TITLE_NAMES" >> $GITHUB_OUTPUT

      # GitHub Release„ÅÆ‰ΩúÊàêÔºà‰æã: softprops/action-gh-release„ÇíÂà©Áî®Ôºâ
      # Create release and attach generated PDFs (only if PDFs were found)
      - name: Create GitHub Release with PDFs
        id: create_release
        if: steps.gather_pdfs.outputs.pdf_count > 0
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "latex-build-${{ steps.release_info.outputs.short_date }}-${{ github.run_number }}"
          name: "[${{ steps.release_info.outputs.title_names }}] - ${{ steps.release_info.outputs.timestamp }}"
          body: |
            ## üìÑ LaTeX Build

            **‚è∞ „Éì„É´„ÉâÊôÇÂàª:** ${{ steps.release_info.outputs.timestamp }}
            **üìù „Ç≥„Éü„ÉÉ„Éà:** [`${{ github.sha }}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
            **üë§ ‰ΩúÊàêËÄÖ:** ${{ github.event.head_commit.author.name }}
            **üí¨ „Ç≥„Éü„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏:** 
            ```
            ${{ github.event.head_commit.message }}
            ```

            ---

            ## üì¶ ÁîüÊàê„Åï„Çå„ÅüPDF„Éï„Ç°„Ç§„É´
            
            ÂêÑPDF„Éï„Ç°„Ç§„É´„ÅØ„ÄÅGitHub„ÅÆÂà∂Èôê„ÇíÂõûÈÅø„Åô„Çã„Åü„ÇÅ„É¶„Éã„Éº„ÇØ„Å™„Éï„Ç°„Ç§„É´ÂêçÔºà`latex_build_YYYYMMDD_HHMMSS_N.pdf`Ôºâ„Åß„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ
            ‰ª•‰∏ã„ÅÆÂØæÂøúË°®„ÅßÂÖÉ„ÅÆTeX„Éï„Ç°„Ç§„É´„Å®„ÅÆÈñ¢ÈÄ£„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
            
            ${{ steps.gather_pdfs.outputs.file_list }}
            
            > **üí° „Éí„É≥„Éà:** „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂæå„ÄÅ„Éï„Ç°„Ç§„É´„ÅÆÊï¥ÂêàÊÄß„ÇíÁ¢∫Ë™ç„Åô„Çã„Å´„ÅØ:
            > - Windows: `certutil -hashfile „Éï„Ç°„Ç§„É´Âêç.pdf SHA256`
            > - Linux/Mac: `sha256sum „Éï„Ç°„Ç§„É´Âêç.pdf`
          files: release_pdfs/*.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
